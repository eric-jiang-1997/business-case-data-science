{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "# load relevant packages\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import seaborn as sns\n",
    "import matplotlib.pyplot as plt\n",
    "import datetime\n",
    "\n",
    "from mlxtend.frequent_patterns import apriori\n",
    "from mlxtend.frequent_patterns import association_rules"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "# load the customer purchasing data\n",
    "file_path = '/Users/ericjiang/Desktop/msci719_assignment/ass5/'\n",
    "file_name = 'data.xlsx'\n",
    "df = pd.read_excel(file_path + file_name)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Member</th>\n",
       "      <th>Order</th>\n",
       "      <th>SKU</th>\n",
       "      <th>Created On</th>\n",
       "      <th>Description</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>M09736</td>\n",
       "      <td>6468572</td>\n",
       "      <td>34993740</td>\n",
       "      <td>22-09-2014 22:45</td>\n",
       "      <td>Other Sauces</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>M09736</td>\n",
       "      <td>6468572</td>\n",
       "      <td>15669800</td>\n",
       "      <td>22-09-2014 22:45</td>\n",
       "      <td>Cashews</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>M09736</td>\n",
       "      <td>6468572</td>\n",
       "      <td>34989501</td>\n",
       "      <td>22-09-2014 22:45</td>\n",
       "      <td>Other Dals</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>M09736</td>\n",
       "      <td>6468572</td>\n",
       "      <td>7572303</td>\n",
       "      <td>22-09-2014 22:45</td>\n",
       "      <td>Namkeen</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>M09736</td>\n",
       "      <td>6468572</td>\n",
       "      <td>15669856</td>\n",
       "      <td>22-09-2014 22:45</td>\n",
       "      <td>Sugar</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Member    Order       SKU        Created On   Description\n",
       "0  M09736  6468572  34993740  22-09-2014 22:45  Other Sauces\n",
       "1  M09736  6468572  15669800  22-09-2014 22:45       Cashews\n",
       "2  M09736  6468572  34989501  22-09-2014 22:45    Other Dals\n",
       "3  M09736  6468572   7572303  22-09-2014 22:45       Namkeen\n",
       "4  M09736  6468572  15669856  22-09-2014 22:45         Sugar"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Library/Anaconda/anaconda3/lib/python3.7/site-packages/ipykernel_launcher.py:2: FutureWarning: using a dict on a Series for aggregation\n",
      "is deprecated and will be removed in a future version. Use                 named aggregation instead.\n",
      "\n",
      "    >>> grouper.agg(name_1=func_1, name_2=func_2)\n",
      "\n",
      "  \n"
     ]
    }
   ],
   "source": [
    "# count the number of items each customer purchased\n",
    "df_count = df['Member'].groupby(df['Member']).agg({'item_count':'count'})\\\n",
    "           .reset_index().sort_values(by='item_count', ascending=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "# extract the top 20 customers\n",
    "df_top_20 = df_count.head(20).reset_index().drop('index',axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [],
   "source": [
    "# append the rank to the top 20 customers\n",
    "rank = []\n",
    "for i in range(20):\n",
    "    rank.append(i+1)\n",
    "df_top_20['rank'] = rank"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Member</th>\n",
       "      <th>item_count</th>\n",
       "      <th>rank</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1438</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>M33064</td>\n",
       "      <td>1318</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>M41747</td>\n",
       "      <td>1131</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>M32409</td>\n",
       "      <td>1106</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>M31966</td>\n",
       "      <td>1102</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>5</td>\n",
       "      <td>M56368</td>\n",
       "      <td>1021</td>\n",
       "      <td>6</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>6</td>\n",
       "      <td>M36432</td>\n",
       "      <td>1001</td>\n",
       "      <td>7</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>7</td>\n",
       "      <td>M41781</td>\n",
       "      <td>920</td>\n",
       "      <td>8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>8</td>\n",
       "      <td>M35538</td>\n",
       "      <td>912</td>\n",
       "      <td>9</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>9</td>\n",
       "      <td>M33491</td>\n",
       "      <td>874</td>\n",
       "      <td>10</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>10</td>\n",
       "      <td>M48101</td>\n",
       "      <td>824</td>\n",
       "      <td>11</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>11</td>\n",
       "      <td>M35649</td>\n",
       "      <td>797</td>\n",
       "      <td>12</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>12</td>\n",
       "      <td>M45470</td>\n",
       "      <td>777</td>\n",
       "      <td>13</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>13</td>\n",
       "      <td>M43831</td>\n",
       "      <td>744</td>\n",
       "      <td>14</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14</td>\n",
       "      <td>M33558</td>\n",
       "      <td>739</td>\n",
       "      <td>15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>15</td>\n",
       "      <td>M32449</td>\n",
       "      <td>735</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>16</td>\n",
       "      <td>M52629</td>\n",
       "      <td>716</td>\n",
       "      <td>17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>17</td>\n",
       "      <td>M55932</td>\n",
       "      <td>694</td>\n",
       "      <td>18</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>18</td>\n",
       "      <td>M43977</td>\n",
       "      <td>682</td>\n",
       "      <td>19</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>19</td>\n",
       "      <td>M78720</td>\n",
       "      <td>682</td>\n",
       "      <td>20</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    Member  item_count  rank\n",
       "0   M38622        1438     1\n",
       "1   M33064        1318     2\n",
       "2   M41747        1131     3\n",
       "3   M32409        1106     4\n",
       "4   M31966        1102     5\n",
       "5   M56368        1021     6\n",
       "6   M36432        1001     7\n",
       "7   M41781         920     8\n",
       "8   M35538         912     9\n",
       "9   M33491         874    10\n",
       "10  M48101         824    11\n",
       "11  M35649         797    12\n",
       "12  M45470         777    13\n",
       "13  M43831         744    14\n",
       "14  M33558         739    15\n",
       "15  M32449         735    16\n",
       "16  M52629         716    17\n",
       "17  M55932         694    18\n",
       "18  M43977         682    19\n",
       "19  M78720         682    20"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_top_20"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "# merge the two datasets, and clean it for further analysis\n",
    "df_combine = df.merge(df_top_20,how='inner',left_on='Member',right_on='Member')\n",
    "df_combine = df_combine[['Member','rank','Order','Description']]\n",
    "df_combine = df_combine.drop_duplicates(keep='first', inplace=False)\n",
    "df_combine = df_combine.sort_values(by=['rank','Order']).reset_index().drop('index',axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Member</th>\n",
       "      <th>rank</th>\n",
       "      <th>Order</th>\n",
       "      <th>Description</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1</td>\n",
       "      <td>6431665</td>\n",
       "      <td>Organic Flours</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1</td>\n",
       "      <td>6431665</td>\n",
       "      <td>Exotic Vegetables</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1</td>\n",
       "      <td>6431665</td>\n",
       "      <td>Glucose, Marie &amp; Milk Biscuits</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1</td>\n",
       "      <td>6431665</td>\n",
       "      <td>Organic Masalas &amp; Spices</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>M38622</td>\n",
       "      <td>1</td>\n",
       "      <td>6431665</td>\n",
       "      <td>Ghee</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14238</td>\n",
       "      <td>M78720</td>\n",
       "      <td>20</td>\n",
       "      <td>8381719</td>\n",
       "      <td>Root Vegetables</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14239</td>\n",
       "      <td>M78720</td>\n",
       "      <td>20</td>\n",
       "      <td>8381719</td>\n",
       "      <td>Other Vegetables</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14240</td>\n",
       "      <td>M78720</td>\n",
       "      <td>20</td>\n",
       "      <td>8381719</td>\n",
       "      <td>Chips</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14241</td>\n",
       "      <td>M78720</td>\n",
       "      <td>20</td>\n",
       "      <td>8381719</td>\n",
       "      <td>Beans</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>14242</td>\n",
       "      <td>M78720</td>\n",
       "      <td>20</td>\n",
       "      <td>8381719</td>\n",
       "      <td>Shampoo</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>14243 rows Ã— 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "       Member  rank    Order                     Description\n",
       "0      M38622     1  6431665                  Organic Flours\n",
       "1      M38622     1  6431665               Exotic Vegetables\n",
       "2      M38622     1  6431665  Glucose, Marie & Milk Biscuits\n",
       "3      M38622     1  6431665        Organic Masalas & Spices\n",
       "4      M38622     1  6431665                            Ghee\n",
       "...       ...   ...      ...                             ...\n",
       "14238  M78720    20  8381719                 Root Vegetables\n",
       "14239  M78720    20  8381719                Other Vegetables\n",
       "14240  M78720    20  8381719                           Chips\n",
       "14241  M78720    20  8381719                           Beans\n",
       "14242  M78720    20  8381719                         Shampoo\n",
       "\n",
       "[14243 rows x 4 columns]"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_combine"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [],
   "source": [
    "# load the current basket for the top 20 customers\n",
    "current_basket = pd.read_csv('Current_Basket.csv')\n",
    "current_basket.head()\n",
    "current_basket = current_basket.drop(\"Members' position in the list\",axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Item1</th>\n",
       "      <th>Item2</th>\n",
       "      <th>Item3</th>\n",
       "      <th>Item4</th>\n",
       "      <th>Item5</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>Raw Rice</td>\n",
       "      <td>Organic F&amp;V</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>Beans</td>\n",
       "      <td>Root Vegetables</td>\n",
       "      <td>Namkeen</td>\n",
       "      <td>Other Vegetables</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>Organic Rice &amp; Rice Products</td>\n",
       "      <td>Avalakki / Poha</td>\n",
       "      <td>Organic F&amp;V</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>Namkeen</td>\n",
       "      <td>Moong Dal</td>\n",
       "      <td>Cream Biscuits</td>\n",
       "      <td>Whole Spices</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>Beans</td>\n",
       "      <td>Ground Coffee</td>\n",
       "      <td>Sooji &amp; Rava</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                          Item1            Item2           Item3  \\\n",
       "0                      Raw Rice      Organic F&V             NaN   \n",
       "1                         Beans  Root Vegetables         Namkeen   \n",
       "2  Organic Rice & Rice Products  Avalakki / Poha     Organic F&V   \n",
       "3                       Namkeen        Moong Dal  Cream Biscuits   \n",
       "4                         Beans    Ground Coffee    Sooji & Rava   \n",
       "\n",
       "              Item4 Item5  \n",
       "0               NaN   NaN  \n",
       "1  Other Vegetables   NaN  \n",
       "2               NaN   NaN  \n",
       "3      Whole Spices   NaN  \n",
       "4               NaN   NaN  "
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "current_basket.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "scrolled": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The result for customer 1\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "       antecedents                               consequents   support\n",
      "36   (Organic F&V)                   (Organic Dals & Pulses)  0.338129\n",
      "63   (Organic F&V)                         (Root Vegetables)  0.309353\n",
      "57   (Organic F&V)                (Organic Masalas & Spices)  0.230216\n",
      "172  (Organic F&V)  (Root Vegetables, Organic Dals & Pulses)  0.223022\n",
      "17   (Organic F&V)                       (Exotic Vegetables)  0.215827\n",
      "******\n",
      "The end for customer 1\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 2\n",
      "    antecedents                          consequents   support\n",
      "11      (Beans)                    (Root Vegetables)  0.387640\n",
      "5       (Beans)                   (Gourd & Cucumber)  0.337079\n",
      "109     (Beans)  (Gourd & Cucumber, Root Vegetables)  0.320225\n",
      "9       (Beans)                   (Other Vegetables)  0.292135\n",
      "120     (Beans)  (Root Vegetables, Other Vegetables)  0.275281\n",
      "******\n",
      "           antecedents                consequents   support\n",
      "10   (Root Vegetables)                    (Beans)  0.387640\n",
      "35   (Root Vegetables)         (Gourd & Cucumber)  0.365169\n",
      "108  (Root Vegetables)  (Gourd & Cucumber, Beans)  0.320225\n",
      "54   (Root Vegetables)         (Other Vegetables)  0.308989\n",
      "119  (Root Vegetables)  (Other Vegetables, Beans)  0.275281\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "            antecedents                          consequents   support\n",
      "55   (Other Vegetables)                    (Root Vegetables)  0.308989\n",
      "8    (Other Vegetables)                              (Beans)  0.292135\n",
      "121  (Other Vegetables)             (Root Vegetables, Beans)  0.275281\n",
      "33   (Other Vegetables)                   (Gourd & Cucumber)  0.258427\n",
      "175  (Other Vegetables)  (Gourd & Cucumber, Root Vegetables)  0.241573\n",
      "******\n",
      "The end for customer 2\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 3\n",
      "                         antecedents  \\\n",
      "164   (Organic Rice & Rice Products)   \n",
      "140   (Organic Rice & Rice Products)   \n",
      "1083  (Organic Rice & Rice Products)   \n",
      "\n",
      "                                    consequents   support  \n",
      "164                          (Other Dry Fruits)  0.150943  \n",
      "140                     (Organic Dals & Pulses)  0.122642  \n",
      "1083  (Other Dry Fruits, Organic Dals & Pulses)  0.103774  \n",
      "******\n",
      "         antecedents              consequents   support\n",
      "2  (Avalakki / Poha)  (Organic Dals & Pulses)  0.132075\n",
      "1  (Avalakki / Poha)      (Exotic Vegetables)  0.113208\n",
      "5  (Avalakki / Poha)       (Other Dry Fruits)  0.113208\n",
      "******\n",
      "        antecedents                           consequents   support\n",
      "161   (Organic F&V)                     (Root Vegetables)  0.226415\n",
      "113   (Organic F&V)                   (Exotic Vegetables)  0.216981\n",
      "159   (Organic F&V)                    (Other Vegetables)  0.216981\n",
      "1133  (Organic F&V)   (Root Vegetables, Other Vegetables)  0.216981\n",
      "983   (Organic F&V)  (Root Vegetables, Exotic Vegetables)  0.198113\n",
      "******\n",
      "The end for customer 3\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 4\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "      antecedents                   consequents   support\n",
      "341   (Moong Dal)                  (Other Dals)  0.246575\n",
      "281   (Moong Dal)            (Gourd & Cucumber)  0.232877\n",
      "345   (Moong Dal)            (Other Vegetables)  0.232877\n",
      "207   (Moong Dal)                    (Brinjals)  0.219178\n",
      "3613  (Moong Dal)  (Other Vegetables, Brinjals)  0.219178\n",
      "******\n",
      "            antecedents                                     consequents  \\\n",
      "263    (Cream Biscuits)                              (Other Vegetables)   \n",
      "4021   (Cream Biscuits)            (Gourd & Cucumber, Other Vegetables)   \n",
      "249    (Cream Biscuits)                              (Gourd & Cucumber)   \n",
      "19683  (Cream Biscuits)  (Gourd & Cucumber, Other Vegetables, Brinjals)   \n",
      "3361   (Cream Biscuits)                    (Gourd & Cucumber, Brinjals)   \n",
      "\n",
      "        support  \n",
      "263    0.630137  \n",
      "4021   0.602740  \n",
      "249    0.602740  \n",
      "19683  0.561644  \n",
      "3361   0.561644  \n",
      "******\n",
      "         antecedents            consequents   support\n",
      "421   (Whole Spices)           (Other Dals)  0.150685\n",
      "42    (Whole Spices)              (Almonds)  0.123288\n",
      "1038  (Whole Spices)  (Other Dals, Almonds)  0.123288\n",
      "235   (Whole Spices)             (Brinjals)  0.109589\n",
      "311   (Whole Spices)     (Gourd & Cucumber)  0.109589\n",
      "******\n",
      "The end for customer 4\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 5\n",
      "    antecedents                          consequents   support\n",
      "17      (Beans)                   (Other Vegetables)  0.598540\n",
      "7       (Beans)                           (Brinjals)  0.489051\n",
      "21      (Beans)                    (Root Vegetables)  0.489051\n",
      "133     (Beans)         (Other Vegetables, Brinjals)  0.481752\n",
      "234     (Beans)  (Root Vegetables, Other Vegetables)  0.467153\n",
      "******\n",
      "         antecedents                consequents   support\n",
      "65   (Ground Coffee)         (Other Vegetables)  0.350365\n",
      "11   (Ground Coffee)                    (Beans)  0.313869\n",
      "187  (Ground Coffee)  (Other Vegetables, Beans)  0.284672\n",
      "69   (Ground Coffee)          (Root Vegetables)  0.277372\n",
      "35   (Ground Coffee)                 (Brinjals)  0.270073\n",
      "******\n",
      "        antecedents                          consequents   support\n",
      "91   (Sooji & Rava)                   (Other Vegetables)  0.175182\n",
      "23   (Sooji & Rava)                              (Beans)  0.138686\n",
      "101  (Sooji & Rava)                    (Root Vegetables)  0.138686\n",
      "241  (Sooji & Rava)            (Other Vegetables, Beans)  0.138686\n",
      "469  (Sooji & Rava)  (Root Vegetables, Other Vegetables)  0.138686\n",
      "******\n",
      "The end for customer 5\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 6\n",
      "            antecedents                consequents   support\n",
      "10   (Other Vegetables)                    (Beans)  0.559322\n",
      "39   (Other Vegetables)         (Gourd & Cucumber)  0.516949\n",
      "138  (Other Vegetables)  (Gourd & Cucumber, Beans)  0.508475\n",
      "76   (Other Vegetables)          (Root Vegetables)  0.330508\n",
      "61   (Other Vegetables)               (Other Dals)  0.330508\n",
      "******\n",
      "    antecedents                           consequents   support\n",
      "3       (Beans)                    (Gourd & Cucumber)  0.779661\n",
      "11      (Beans)                    (Other Vegetables)  0.559322\n",
      "9       (Beans)                          (Other Dals)  0.533898\n",
      "17      (Beans)                     (Root Vegetables)  0.525424\n",
      "139     (Beans)  (Gourd & Cucumber, Other Vegetables)  0.508475\n",
      "******\n",
      "    antecedents                consequents   support\n",
      "1    (Brinjals)                    (Beans)  0.262712\n",
      "27   (Brinjals)         (Gourd & Cucumber)  0.237288\n",
      "103  (Brinjals)  (Gourd & Cucumber, Beans)  0.237288\n",
      "31   (Brinjals)         (Other Vegetables)  0.220339\n",
      "115  (Brinjals)  (Other Vegetables, Beans)  0.211864\n",
      "******\n",
      "The end for customer 6\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 7\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "          antecedents         consequents   support\n",
      "9  (Other Vegetables)  (Gourd & Cucumber)  0.152709\n",
      "2  (Other Vegetables)             (Beans)  0.103448\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 7\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 8\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "           antecedents                   consequents   support\n",
      "43   (Root Vegetables)            (Other Vegetables)  0.299065\n",
      "22   (Root Vegetables)                    (Brinjals)  0.271028\n",
      "10   (Root Vegetables)                       (Beans)  0.214953\n",
      "123  (Root Vegetables)  (Other Vegetables, Brinjals)  0.205607\n",
      "37   (Root Vegetables)                     (Namkeen)  0.158879\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 8\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 9\n",
      "       antecedents                consequents   support\n",
      "15   (Snacky Nuts)                   (Banana)  0.478261\n",
      "51   (Snacky Nuts)          (Root Vegetables)  0.460870\n",
      "153  (Snacky Nuts)  (Banana, Root Vegetables)  0.391304\n",
      "43   (Snacky Nuts)              (Organic F&V)  0.382609\n",
      "37   (Snacky Nuts)                  (Namkeen)  0.304348\n",
      "******\n",
      "           antecedents            consequents   support\n",
      "13   (Root Vegetables)               (Banana)  0.608696\n",
      "50   (Root Vegetables)          (Snacky Nuts)  0.460870\n",
      "22   (Root Vegetables)                (Beans)  0.443478\n",
      "40   (Root Vegetables)          (Organic F&V)  0.408696\n",
      "152  (Root Vegetables)  (Banana, Snacky Nuts)  0.391304\n",
      "******\n",
      "    antecedents                     consequents   support\n",
      "12     (Banana)               (Root Vegetables)  0.608696\n",
      "14     (Banana)                   (Snacky Nuts)  0.478261\n",
      "6      (Banana)                   (Organic F&V)  0.426087\n",
      "151    (Banana)  (Root Vegetables, Snacky Nuts)  0.391304\n",
      "0      (Banana)                         (Beans)  0.382609\n",
      "******\n",
      "The end for customer 9\n",
      "\n",
      "\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The result for customer 10\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "            antecedents         consequents   support\n",
      "36  (Exotic Vegetables)          (Brinjals)  0.275641\n",
      "7   (Exotic Vegetables)            (Banana)  0.243590\n",
      "47  (Exotic Vegetables)  (Gourd & Cucumber)  0.237179\n",
      "50  (Exotic Vegetables)  (Other Vegetables)  0.217949\n",
      "52  (Exotic Vegetables)   (Root Vegetables)  0.217949\n",
      "******\n",
      "The end for customer 10\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 11\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "       antecedents      consequents   support\n",
      "19  (Other Juices)  (Ground Coffee)  0.104839\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 11\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 12\n",
      "    antecedents               consequents   support\n",
      "36     (Banana)         (Root Vegetables)  0.555556\n",
      "12     (Banana)                   (Beans)  0.388889\n",
      "197    (Banana)  (Root Vegetables, Beans)  0.322222\n",
      "44     (Banana)            (Whole Spices)  0.300000\n",
      "28     (Banana)              (Other Dals)  0.266667\n",
      "******\n",
      "        antecedents                consequents   support\n",
      "45   (Whole Spices)                   (Banana)  0.300000\n",
      "111  (Whole Spices)          (Root Vegetables)  0.300000\n",
      "301  (Whole Spices)  (Banana, Root Vegetables)  0.266667\n",
      "64   (Whole Spices)                    (Beans)  0.211111\n",
      "366  (Whole Spices)   (Root Vegetables, Beans)  0.200000\n",
      "******\n",
      "    antecedents                consequents   support\n",
      "103   (Raisins)          (Root Vegetables)  0.155556\n",
      "35    (Raisins)                   (Banana)  0.133333\n",
      "289   (Raisins)  (Banana, Root Vegetables)  0.111111\n",
      "******\n",
      "The end for customer 12\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 13\n",
      "   antecedents               consequents   support\n",
      "6    (Namkeen)                   (Beans)  0.166667\n",
      "22   (Namkeen)         (Root Vegetables)  0.134921\n",
      "55   (Namkeen)  (Root Vegetables, Beans)  0.119048\n",
      "******\n",
      "   antecedents               consequents   support\n",
      "17     (Chips)         (Root Vegetables)  0.222222\n",
      "3      (Chips)                   (Beans)  0.214286\n",
      "45     (Chips)  (Root Vegetables, Beans)  0.158730\n",
      "******\n",
      "The end for customer 13\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 14\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "     antecedents        consequents   support\n",
      "10  (Other Dals)             (Curd)  0.176991\n",
      "14  (Other Dals)        (Moong Dal)  0.141593\n",
      "18  (Other Dals)  (Root Vegetables)  0.123894\n",
      "******\n",
      "The end for customer 14\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 15\n",
      "    antecedents               consequents   support\n",
      "0      (Banana)                   (Beans)  0.558140\n",
      "18     (Banana)         (Root Vegetables)  0.453488\n",
      "16     (Banana)                (Raw Rice)  0.395349\n",
      "203    (Banana)  (Root Vegetables, Beans)  0.360465\n",
      "14     (Banana)        (Other Vegetables)  0.348837\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 15\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 16\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "          antecedents      consequents   support\n",
      "24  (Diapers & Wipes)  (Ground Coffee)  0.159664\n",
      "3   (Diapers & Wipes)          (Beans)  0.100840\n",
      "******\n",
      "The end for customer 16\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 17\n",
      "   antecedents                           consequents   support\n",
      "8     (Banana)                         (Organic F&V)  0.178947\n",
      "10    (Banana)                    (Other Vegetables)  0.178947\n",
      "5     (Banana)                    (Gourd & Cucumber)  0.147368\n",
      "76    (Banana)  (Gourd & Cucumber, Other Vegetables)  0.136842\n",
      "6     (Banana)                             (Namkeen)  0.126316\n",
      "******\n",
      "   antecedents       consequents   support\n",
      "50   (Namkeen)     (Organic F&V)  0.263158\n",
      "28   (Namkeen)  (Cream Biscuits)  0.252632\n",
      "52   (Namkeen)    (Other Juices)  0.252632\n",
      "24   (Namkeen)     (Corn Snacks)  0.200000\n",
      "42   (Namkeen)   (Health Drinks)  0.168421\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 17\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 18\n",
      "       antecedents                          consequents   support\n",
      "49   (Organic F&V)                   (Other Vegetables)  0.468085\n",
      "51   (Organic F&V)                    (Root Vegetables)  0.414894\n",
      "19   (Organic F&V)                           (Brinjals)  0.382979\n",
      "191  (Organic F&V)  (Other Vegetables, Root Vegetables)  0.329787\n",
      "137  (Organic F&V)         (Other Vegetables, Brinjals)  0.297872\n",
      "******\n",
      "   antecedents                          consequents   support\n",
      "6     (Banana)                   (Other Vegetables)  0.297872\n",
      "8     (Banana)                    (Root Vegetables)  0.244681\n",
      "0     (Banana)                           (Brinjals)  0.223404\n",
      "99    (Banana)  (Other Vegetables, Root Vegetables)  0.212766\n",
      "75    (Banana)         (Other Vegetables, Brinjals)  0.202128\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "Empty DataFrame\n",
      "Columns: [antecedents, consequents, support]\n",
      "Index: []\n",
      "******\n",
      "The end for customer 18\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 19\n",
      "     antecedents               consequents   support\n",
      "315   (Urad Dal)                (Toor Dal)  0.272727\n",
      "319   (Urad Dal)            (Whole Spices)  0.236364\n",
      "243   (Urad Dal)              (Other Dals)  0.236364\n",
      "283   (Urad Dal)                (Raw Rice)  0.218182\n",
      "1411  (Urad Dal)  (Toor Dal, Whole Spices)  0.200000\n",
      "******\n",
      "   antecedents         consequents   support\n",
      "11   (Almonds)  (Other Dry Fruits)  0.236364\n",
      "29   (Almonds)      (Whole Spices)  0.236364\n",
      "9    (Almonds)        (Other Dals)  0.218182\n",
      "0    (Almonds)           (Cashews)  0.181818\n",
      "4    (Almonds)     (Ground Coffee)  0.181818\n",
      "******\n",
      "    antecedents          consequents   support\n",
      "284  (Raw Rice)       (Whole Spices)  0.290909\n",
      "229  (Raw Rice)         (Other Dals)  0.272727\n",
      "280  (Raw Rice)           (Toor Dal)  0.254545\n",
      "282  (Raw Rice)           (Urad Dal)  0.218182\n",
      "137  (Raw Rice)  (Exotic Vegetables)  0.218182\n",
      "******\n",
      "The end for customer 19\n",
      "\n",
      "\n",
      "\n",
      "The result for customer 20\n",
      "    antecedents         consequents   support\n",
      "11      (Chips)            (Banana)  0.349206\n",
      "92      (Chips)             (Bread)  0.269841\n",
      "147     (Chips)          (Toor Dal)  0.269841\n",
      "143     (Chips)  (Other Vegetables)  0.238095\n",
      "322     (Chips)     (Banana, Bread)  0.238095\n",
      "******\n",
      "          antecedents         consequents   support\n",
      "21   (Instant Pastas)            (Banana)  0.222222\n",
      "100  (Instant Pastas)             (Bread)  0.158730\n",
      "134  (Instant Pastas)             (Chips)  0.158730\n",
      "184  (Instant Pastas)      (Other Sweets)  0.158730\n",
      "186  (Instant Pastas)  (Other Vegetables)  0.158730\n",
      "******\n",
      "The end for customer 20\n",
      "\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "# define a function for further use\n",
    "def encode_units(x):\n",
    "    if x <= 0:\n",
    "        return 0\n",
    "    if x >= 1:\n",
    "        return 1\n",
    "    \n",
    "\n",
    "# the main part for iteration\n",
    "for i in range(20):\n",
    "    # extract the purchasing data for a specific customer\n",
    "    df_sub = df_combine[df_combine['rank']==i+1].drop(['Member','rank'],axis=1)\n",
    "    # reshape the dataset\n",
    "    basket = df_sub.groupby(['Order','Description'])['Description'].count().unstack()\\\n",
    "             .reset_index().fillna(0).set_index('Order')\n",
    "    basket_sets = basket.applymap(encode_units)\n",
    "    # apply association rule mining functions\n",
    "    frequent_itemsets = apriori(basket_sets,min_support=0.1,use_colnames=True)\n",
    "    rules = association_rules(frequent_itemsets,support_only=True,min_threshold=0.1)\n",
    "    # read the current basket of a specific customer\n",
    "    a = list(current_basket.iloc[i])\n",
    "    # drop null values\n",
    "    b = [x for x in a if str(x) != 'nan']\n",
    "    antecedent = b\n",
    "    print('The result for customer'+' '+str(i+1))\n",
    "    # sub iteration part: for each item in the current basket, find the top 5 consequents regarding support value\n",
    "    for item in antecedent:\n",
    "        result = rules[rules['antecedents']=={item}].sort_values(['support'],ascending=False).head(5)\n",
    "        print(result[['antecedents','consequents','support']])\n",
    "        print('******')\n",
    "    print('The end for customer'+' '+str(i+1))\n",
    "    print()\n",
    "    print()\n",
    "    print()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
